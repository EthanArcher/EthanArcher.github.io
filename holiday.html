<!DOCTYPE html>
<html>
  <head>
    <title>Holiday Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Holiday Map" />
    <link rel="apple-touch-icon" href="images/dinnerBuilderIcon.png" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <link rel="icon" href="images/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="assets/css/main.css" />
  </head>

  <body class="no-scroll">
      <section id="header" style="padding: 0; margin: 0">
        <div id="controls" class="content" style="display: flex; gap: 0.5em; align-items: center; padding: 0.5em 0; justify-content: center">
          <div style="display: flex; flex-direction: column">
            <select id="countrySelect">
              <option value="all">All countries</option>
            </select>
          </div>
          <div style="display: flex; flex-direction: column">
            <select id="daySelect">
              <option value="all">All days</option>
            </select>
          </div>
        </div>
      </section>
    <section id="map">
      <div id="map"></div>
    </section>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
      let places = [];
      const map = L.map("map").setView([51, -115], 6);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
      }).addTo(map);

      let routeLine;
      let markers = [];
      let markerCluster; // Add this at the top with your other variables
      const daySelect = document.getElementById("daySelect");
      const countrySelect = document.getElementById("countrySelect");

      function fillCountrySelector() {
        while (countrySelect.options.length > 1) {
          countrySelect.remove(1);
        }
        const uniqueCountries = [...new Set(places.map((p) => p.country))];
        uniqueCountries.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          countrySelect.appendChild(opt);
        });
      }

      function fillDaySelector(filteredPlaces) {
        while (daySelect.options.length > 1) {
          daySelect.remove(1);
        }
        const uniqueDates = [...new Set(filteredPlaces.map((p) => p.date))];
        uniqueDates.forEach((d) => {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          daySelect.appendChild(opt);
        });
      }

      function renderDay() {
        map.eachLayer((layer) => {
          if (layer instanceof L.MarkerClusterGroup || layer instanceof L.Marker || layer instanceof L.Polyline) {
            map.removeLayer(layer);
          }
        });

        if (markerCluster) {
          map.removeLayer(markerCluster);
        }
        markerCluster = L.markerClusterGroup();
        markers = [];

        const selectedCountry = countrySelect.value;
        const selectedDay = daySelect.value;
        let filteredPlaces = places;
        if (selectedCountry !== "all") {
          filteredPlaces = filteredPlaces.filter((p) => p.country === selectedCountry);
        }
        if (selectedDay !== "all") {
          filteredPlaces = filteredPlaces.filter((p) => p.date === selectedDay);
        }

        // --- Only add unique markers for start/end if they are the same ---
        let markerCoords = new Set();
        filteredPlaces.forEach((place, idx) => {
          // If first or last, check for duplicate
          if (
            (idx === 0 || idx === filteredPlaces.length - 1) &&
            filteredPlaces.length > 1
          ) {
            const first = filteredPlaces[0].coords.join(",");
            const last = filteredPlaces[filteredPlaces.length - 1].coords.join(",");
            if (first === last && idx === filteredPlaces.length - 1) {
              // Already added as first, skip last
              return;
            }
          }
          const coordKey = place.coords.join(",");
          if (!markerCoords.has(coordKey)) {
            const marker = L.marker(place.coords)
              .bindPopup(`<b>${place.name}</b><br>${place.date}`)
              .bindTooltip(place.name, { permanent: false, direction: "top", offset: [0, -10] });
            markers.push(marker);
            markerCluster.addLayer(marker);
            markerCoords.add(coordKey);
          }
        });
        map.addLayer(markerCluster);

        if (filteredPlaces.length > 1) {
          routeLine = L.polyline(
            filteredPlaces.map((p) => p.coords),
            { color: "blue", weight: 3, opacity: 0.7 }
          ).addTo(map);
          map.fitBounds(routeLine.getBounds());
        } else if (filteredPlaces.length === 1) {
          map.setView(filteredPlaces[0].coords, 10);
        }

        updateTooltips();
      }

      function updateTooltips() {
        const show = map.getZoom() >= 5;
        markers.forEach((marker) => {
          if (show) {
            marker.openTooltip();
          } else {
            marker.closeTooltip();
          }
        });
      }
      map.on("zoomend", updateTooltips);

      daySelect.addEventListener("change", renderDay);
      countrySelect.addEventListener("change", () => {
        // When country changes, update day selector to only show days for that country
        const selectedCountry = countrySelect.value;
        const filteredPlaces = selectedCountry !== "all" ? places.filter((p) => p.country === selectedCountry) : places;
        fillDaySelector(filteredPlaces);
        renderDay();
      });

      function initHolidayMap() {
        fetch("assets/resources/holiday-places.json")
          .then((response) => response.json())
          .then((data) => {
            places = data;
            fillCountrySelector();
            fillDaySelector(places);
            renderDay();
          })
          .catch((err) => {
            alert("Failed to load holiday places data.");
            console.error(err);
          });
      }

      initHolidayMap();
    </script>
  </body>
</html>
