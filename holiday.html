<!DOCTYPE html>
<html>
  <head>
    <title>Holiday Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Holiday Map" />
    <link rel="apple-touch-icon" href="images/dinnerBuilderIcon.png" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <link rel="icon" href="images/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="assets/css/main.css" />
  </head>
  
  <body>
    <div id="wrapper">
      <section id="header">
        <div id="controls" class="content">
          <label for="daySelect">Select Day:</label>
          <select id="daySelect">
            <option value="all">Show All</option>
          </select>
        </div>
      </section>
    </div>
    <section id="map">
      <div id="map"></div>
    </section>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      let places = [];
      const map = L.map("map").setView([51, -115], 6);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
      }).addTo(map);

      let routeLine;
      let markers = [];
      const daySelect = document.getElementById("daySelect");

      function fillDaySelector() {
        while (daySelect.options.length > 1) {
          daySelect.remove(1);
        }
        const uniqueDates = [...new Set(places.map((p) => p.date))];
        uniqueDates.forEach((d) => {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          daySelect.appendChild(opt);
        });
      }

      function renderDay(filterDate) {
        map.eachLayer((layer) => {
          if (layer instanceof L.Marker || layer instanceof L.Polyline) {
            map.removeLayer(layer);
          }
        });
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "© OpenStreetMap contributors",
        }).addTo(map);
        markers = [];
        const dayPlaces = places.filter((p) => filterDate === "all" || p.date === filterDate);
        dayPlaces.forEach((place) => {
          const marker = L.marker(place.coords)
            .addTo(map)
            .bindPopup(`<b>${place.name}</b><br>${place.date}`)
            .bindTooltip(place.name, { permanent: false, direction: "top", offset: [0, -10] });
          markers.push(marker);
        });
        if (dayPlaces.length > 1) {
          routeLine = L.polyline(
            dayPlaces.map((p) => p.coords),
            { color: "blue", weight: 3, opacity: 0.7 }
          ).addTo(map);
          map.fitBounds(routeLine.getBounds());
        } else if (dayPlaces.length === 1) {
          map.setView(dayPlaces[0].coords, 10);
        }
      }

      function updateTooltips() {
        const show = map.getZoom() >= 7;
        markers.forEach((marker) => {
          if (show) {
            marker.openTooltip();
          } else {
            marker.closeTooltip();
          }
        });
      }
      map.on("zoomend", updateTooltips);

      daySelect.addEventListener("change", () => renderDay(daySelect.value));

      fetch("assets/resources/holiday-places.json")
        .then((response) => response.json())
        .then((data) => {
          places = data;
          fillDaySelector();
          renderDay("all");
        })
        .catch((err) => {
          alert("Failed to load holiday places data.");
          console.error(err);
        });
    </script>
  </body>
</html>
